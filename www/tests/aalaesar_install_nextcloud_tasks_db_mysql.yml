- name: '[mySQL] - Service is installed.'
  package:
    name: '{{ nextcloud_db_backend }}-server'
    state: present
  register: nc_mysql_db_install
- loop:
  - php{{ php_ver }}-mysql
  - python-mysqldb
  name: '[mySQL] - Packages are installed.i'
  package:
    name: '{{ item }}'
    state: present
- name: '[mySQL] - generate {{ nextcloud_db_backend }} root Password:'
  set_fact:
    nextcloud_mysql_root_pwd: '{{ lookup( ''password'', ''nextcloud_instances/''+
      nextcloud_instance_name +''/mysql_root.pwd'' ) }}'
  when: nextcloud_mysql_root_pwd is not defined
- ignore_errors: true
  mysql_user:
    check_implicit_admin: true
    config_file: /etc/mysql/debian.cnf
    host: '{{ item }}'
    name: root
    password: '{{ nextcloud_mysql_root_pwd }}'
    priv: '*.*:ALL,GRANT'
  name: '[mySQL] - Update {{ nextcloud_db_backend }} root password'
  with_items:
  - 127.0.0.1
  - ::1
  - localhost
- ignore_errors: true
  mysql_user:
    login_password: '{{ nextcloud_mysql_root_pwd }}'
    login_user: root
    state: absent
    user: ''
  name: '[mySQL] - Delete the anonymous user.'
- ignore_errors: true
  mysql_db:
    login_password: '{{ nextcloud_mysql_root_pwd }}'
    login_user: root
    name: test
    state: absent
  name: '[mySQL] - Removes the MySQL test database'
  when: nc_mysql_db_install.changed
- copy:
    dest: /etc/mysql/conf.d/nextcloud.cnf
    src: files/mysql_nextcloud.cnf
  name: '[mySQL] - Set mysql confing option for nextcloud'
  notify: restart mysql
- name: '[mySQL] - Generate database user Password.'
  set_fact:
    nextcloud_db_pwd: '{{ lookup( ''password'', ''nextcloud_instances/''+ nextcloud_instance_name
      +''/db_admin.pwd'' ) }}'
  when: nextcloud_db_pwd is not defined
- mysql_db:
    login_password: '{{ nextcloud_mysql_root_pwd }}'
    login_user: root
    name: '{{ nextcloud_db_name }}'
    state: present
  name: '[mySQL] - Add Database {{ nextcloud_db_name }}.'
- mysql_user:
    login_password: '{{ nextcloud_mysql_root_pwd }}'
    login_user: root
    name: '{{ nextcloud_db_admin }}'
    password: '{{ nextcloud_db_pwd }}'
    priv: '{{ nextcloud_db_name }}.*:ALL'
    state: present
  name: '[mySQL] - Configure the database user.'
